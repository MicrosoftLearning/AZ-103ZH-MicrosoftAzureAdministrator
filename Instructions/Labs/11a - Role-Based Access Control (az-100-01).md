---
lab:
    title: '基于角色的访问控制'
    module: '管理 Azure 订阅和资源'
---

# 逻辑阵列模块：基于角色的访问控制 

本逻辑阵列模块中的所有任务都是从 Azure 门户执行的（包括 PowerShell Cloud Shell 会话）  

   > **注**：不使用 Cloud Shell 时，逻辑阵列模块虚拟机必须安装 Azure PowerShell 1.2.0 模块（或更新版本） [https://docs.microsoft.com/zh-cn/powershell/azure/install-az-ps?view=azps-1.2.0](https://docs.microsoft.com/zh-cn/powershell/azure/install-az-ps?view=azps-1.2.0)

逻辑阵列模块文件：无

### 方案
  
Adatum Corporation 希望使用 Azure 基于角色的访问控制和 Azure 策略来控制其 Azure 资源的配置和管理。它还希望能够自动化和跟踪配置和管理任务。

### 目标
  
完成本逻辑阵列模块后，您将能够：

-  通过使用内置的基于角色的访问控制（RBAC）角色和内置 Azure 策略，配置 Azure 资源的配置和管理委派

-  通过将 Azure 资源配置为委派管理和审核配置事件来验证委派


### 练习 1：通过使用内置的基于角色的访问控制（RBAC）角色和内置 Azure 策略，配置 Azure 资源的配置和管理委派

本次练习的主要任务如下：

1. 请创建 Azure AD 用户和群组。

1. 创建资源组

1. 通过内置 RBAC 角色委派 Azure 资源组的管理

1. 将内置 Azure 策略分配给 Azure 资源组


#### 任务 1：请创建 Azure AD 用户和群组。

1. 从逻辑阵列模块虚拟机启动 Microsoft Edge，浏览到 Azure 门户 [**http://portal.azure.com**](http://portal.azure.com) 并使用 Microsoft 帐户登录，该帐户在您打算在本逻辑阵列模块中使用的 Azure 订阅中具有所有者角色，并且是与该订阅关联的 Azure AD 租户的全局管理员。

1. 在 Azure 门户中，导航到 **Azure Active Directory** 边栏选项卡 

1. 从 **Azure Active Directory** 边栏选项卡，导航到 **自定义域名** 边栏选项卡并标识与 Azure AD 租户关联的主 DNS 域名。注意它的价值 - 您将在此任务中稍后使用它。

1. 从 Azure AD **自定义域名** 边栏选项卡，导航到 **用户 - 所有用户** 边栏选项卡。 

1. 从 **用户 - 所有用户** 目录边栏选项卡，创建一个新的“Azure AD 租户”，设置如下：：

    - 名称： **aaduser100011**

    - 用户名： **aaduser100011@&lt;DNS-domain-name&gt;** 其中 &lt;DNS-domain-name&gt; 表示您在此任务中先前确定的主 DNS 域名。

    - 个人资料： **未配置**

    - 属性： **默认**

    - 群组： **选定了 0 个组**

    - 目录角色： **用户**

    - 密码：选中 **显示密码** 复选框并注意 **密码** 文本框中出现的字符串。在本逻辑阵列模块中，您后续将需要该域名。

1. 从 **用户 - 所有用户** 边栏选项卡，导航到 **群组 - 所有群组** 边栏选项卡。 

1. 从 **组 - 所有组** 边栏选项卡中，使用以下设置创建新组：

    - 组类型: **安全**

    - 组名称： **az1001 贡献者**

    - 小组介绍： **az1001 贡献者**

    - 成员身份类型： **已分配**

    - 成员： **aaduser100011**


#### 任务 2：创建资源组

1. 在 Azure 门户中，导航到 **资源组** 边栏选项卡。

1. 来自 **资源组** 边栏选项卡，使用以下设置创建第一个资源组：

    - 资源组名称：**az1000101-RG**

    - 订阅：您希望用于本逻辑阵列模块的订阅名称

    - 资源组位置：最靠近逻辑阵列模块位置的 Azure 区域的名称以及可以在其中设置 Azure VM 的位置。

   > **注**：要识别订阅中可用的 Azure 区域，请参阅 [**https://azure.microsoft.com/zh-cn/regions/offers/**](https://azure.microsoft.com/zh-cn/regions/offers/)

1. 从 **资源组** 边栏选项卡，使用以下设置创建第二个资源组：

    - 资源组名称：**az1000102-RG**

    - 订阅：您希望用于本逻辑阵列模块的订阅名称

    - 资源组位置：您在上一步中选择的 Azure 区域的名称


#### 任务 3：通过内置 RBAC 角色委派 Azure 资源组的管理

1. 在 Azure 门户中，从 **资源组** 边栏选项卡，导航到 **az1000101-RG** 边栏选项卡。

1. 从 **az1000101-RG** 边栏选项卡，展示它 **访问控制（IAM）** 边栏选项卡。

1. 从 **az1000101-RG  - 访问控制（IAM）** 边栏选项卡，显示 **角色分配**  边栏选项卡。

1. 从 **角色分配** 边栏选项卡，创建以下 **角色分配**：

    - 角色 **参与者**

    - 分配访问权限： **Azure AD 用户，组或服务主体**

    - 选择: **az1001-1b**。


#### 任务 4：将内置 Azure 策略分配给 Azure 资源组

1. 从 **az1000101-RG** 边栏选项卡，展示它 **政策** 边栏选项卡。

1. 从 **政策 - 合规** 边栏选项卡，显示 **分配政策** 边栏选项卡。

1. 根据以下设置分配政策：

    - 范围： **az1000101-RG**

    - 排除：将条目留空

    - 政策定义： **允许的虚拟机 SKU**

    - 作业名称： **允许的虚拟机 SKU**

    - 描述： **允许选择的虚拟机 SKU（Standard_DS1_v2）**

    - 分配方：将条目设置保留为其默认值
	
    - 允许的 SKU： **Standard_DS1_v2**

    - 创建托管标识：将条目留空

> **结果**：完成本次练习后，您已创建 Azure AD 用户和 Azure AD 组，创建了两个 Azure 资源组，通过内置 Azure VM Contributor RBAC 角色委派了第一个 Azure 资源组的管理，并分配给相同的资源对内置 Azure 策略进行分组，限制可用于 Azure VM 的 SKU。


### 练习 2：通过将 Azure 资源配置为委派管理和审核配置事件来验证委派
  
本次练习的主要任务如下：

1. 确定 Azure VM 部署的可用 DNS 名称

1. 尝试将策略不兼容的 Azure VM 自动部署为委派管理员

1. 作为委派管理员执行符合策略的 Azure VM 的自动部署

1. 查看与 Azure VM 部署相对应的 Azure 活动日志事件


#### 任务 1：确定 Azure VM 部署的可用 DNS 名称

1. 在 Azure 门户中，在 Cloud Shell 中启动 PowerShell 会话。 

   > **注**：如果这是您第一次在当前 Azure 订阅中启动 Cloud Shell，则会要求您创建 Azure 文件共享以保留 Cloud Shell 文件。如果是，接受默认设置，这样会在自动生成的资源组中创建存储帐户。

1. 在 Cloud Shell 窗格中，运行以下命令，替换占位符 &lt;custom-label&gt; 任何可能是唯一的字符串和占位符 &lt;location-of-az1000101-RG&gt; 使用您在其中创建的 Azure 区域的名称 **az1000101-RG** 资源组。

   ```
   Test-AzDnsAvailability -DomainNameLabel <custom-label> -Location '<location-of-az1000101-RG>'
   ```

1. 验证返回的命令是否为 **真**。如果没有，请使用 &lt;custom-label&gt; 的不同值重新运行相同的命令。直到命令返回 **真**。 

1. 请注意导致成功结果的<custom-label>的值。您将在下一个任务中使用它

1. 运行以下命令：

   ```
   Register-AzResourceProvider –ProviderNamespace Microsoft.Network
   ```

   ```
   Register-AzResourceProvider –ProviderNamespace Microsoft.Compute
   ```
注：这些 cmdlet 注册 Azure 资源管理器 Microsoft.Network 和 Microsoft.Compute 资源提供程序。这是使用 Azure 资源管理器模板部署由这些资源提供程序管理的资源时所需的一次性操作（每个订阅）（如果这些资源提供程序尚未注册）。



#### 任务 2：尝试将策略不兼容的 Azure VM 自动部署为委派管理员

1. 在专用模式下启动另一个浏览器窗口。

1. 在新的浏览器窗口中，导航到 Azure 门户并使用您在上一个练习中创建的用户帐户登录。出现提示时，将密码更改为新值。

1. 在 Azure 门户中，导航到 **资源组** 边栏选项卡并注意您只能查看资源组 **az1000101-RG**。

1. 在 Azure 门户中，导航到 **创建资源** 边栏选项卡。 

1. 从 **创建资源** 边栏选项卡中搜索 Azure Marketplace 中的 **模板部署**。

1. 使用搜索结果列表导航到 **部署自定义模板** 边栏选项卡。

1. 在 **自定义部署** 边栏选项卡，在 **加载 GitHub 快速入门模板** 下拉列表，选择 **101-VM-简单 Linux 的** 进入并导航到 **编辑模板** 边栏选项卡。

1. 在 **编辑模板** 边栏选项卡，导航到 **变量** 部分并找到 **vmSize** 条目。

1. 请注意，模板使用硬编码 **Standard_A1** VM 大小。

1. 放弃您可能对模板所做的任何更改并导航到 **部署一个简单的 Ubuntu Linux VM** 边栏选项卡。

1. 从 **部署一个简单的 Ubuntu Linux VM** 边栏选项卡，使用以下设置启动模板部署：

    - 订阅：您在上一个练习中选择的订阅

    - 资源组： **az1000101-RG**

    - 位置：您在上一个练习中选择的 Azure 区域的名称

    - 管理员用户名：**学生**

    - 管理员密码：**Pa55w.rd1234**

    - Dns 标签前缀：您在上一个任务中标识的<custom-label>

    - Ubuntu OS 版：接受默认值

    - 位置：接受默认值
    
1. 请注意，部署的启动失败。导航到 **错误** 边栏选项卡并注意策略不允许部署资源 **允许的虚拟机 SKU**。   


#### 任务 3：作为委派管理员执行符合策略的 Azure VM 的自动部署
 
1. 从 **部署一个简单的 Ubuntu Linux VM** 边栏选项卡，导航到 **编辑模板** 边栏选项卡。

1. 在 **编辑模板** 边栏选项卡，导航回到 **变量** 部分并找到 **vmSize** 条目。

1. 替换值 **Standard_A1** 同 **Standard_DS1_v2** 并保存更改。

1. 再次启动部署。请注意，此次验证成功。 

1. 请勿等待第一台虚拟机预配完成，请继续进行下一个任务


#### 任务 4：查看与 Azure VM 部署相对应的 Azure 活动日志事件

1. 切换到上一练习中使用的浏览器窗口。

1. 在 Azure 门户中，导航到 **az1000101-RG** 资源组边栏选项卡。

1. 从 **az1000101-RG** 资源组边栏选项卡，显示它 **活动日志** 边栏选项卡。 

1. 在操作列表中，请注意与失败和成功验证事件对应的操作。 

1. 刷新刀片视图并观察与 Azure VM 配置相对应的事件，包括表示成功部署的最后一个事件。

> **结果**：完成此练习后，您已为 Azure VM 部署确定了可用的 DNS 名称，尝试将策略不兼容的 Azure VM 自动部署为委派管理员，执行自动部署符合策略的 Azure VM 作为相同的委派管理员，并查看了与 Azure VM 部署相对应的 Azure 活动日志条目。
